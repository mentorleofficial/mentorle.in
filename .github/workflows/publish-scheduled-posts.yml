name: Publish Scheduled Posts

on:
  schedule:
    # Runs every 5 minutes (GitHub Actions uses UTC)
    # Format: minute hour day month day-of-week
    - cron: "*/5 * * * *"
  workflow_dispatch: # Allow manual trigger from Actions tab

jobs:
  publish-scheduled-posts:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Call publish-scheduled-posts endpoint
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          CRON_ENDPOINT: ${{ secrets.CRON_ENDPOINT }}
        run: |
          echo "üîÑ Checking for scheduled posts to publish..."
          
          if [ -z "$CRON_SECRET" ]; then
            echo "‚ùå Error: CRON_SECRET is not set in GitHub Secrets"
            exit 1
          fi
          
          if [ -z "$CRON_ENDPOINT" ]; then
            echo "‚ùå Error: CRON_ENDPOINT is not set in GitHub Secrets"
            exit 1
          fi
          
          # Validate URL format
          if [[ ! "$CRON_ENDPOINT" =~ ^https:// ]]; then
            echo "‚ö†Ô∏è  Warning: CRON_ENDPOINT should use HTTPS. Current: $CRON_ENDPOINT"
          fi
          
          # Ensure URL doesn't have trailing slash (Next.js API routes don't need it)
          CRON_ENDPOINT=$(echo "$CRON_ENDPOINT" | sed 's|/$||')
          
          echo "üîó Calling endpoint: $CRON_ENDPOINT"
          
          # Use -L to follow redirects (handles 308 Permanent Redirect)
          response=$(curl -sS -L -w "\n%{http_code}" -X GET \
            -H "Authorization: Bearer $CRON_SECRET" \
            "$CRON_ENDPOINT")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "üìä Response Status: $http_code"
          echo "üìÑ Response Body: $body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Successfully processed scheduled posts"
          elif [ "$http_code" -eq 401 ]; then
            echo "‚ùå Unauthorized: Check that CRON_SECRET matches your deployment environment"
            exit 1
          elif [ "$http_code" -eq 308 ] || [ "$http_code" -eq 301 ] || [ "$http_code" -eq 302 ]; then
            echo "‚ö†Ô∏è  Redirect detected (${http_code}). Ensure CRON_ENDPOINT uses HTTPS and correct URL format."
            echo "üí° Example: https://yourdomain.com/api/cron/publish-scheduled-posts"
            exit 1
          else
            echo "‚ö†Ô∏è  Unexpected response code: $http_code"
            exit 1
          fi

